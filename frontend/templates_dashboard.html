<!DOCTYPE html>
<html>
<head>
    <title>Template Management Dashboard</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: #f5f7fa; }
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; border-bottom: 3px solid #9b59b6; padding-bottom: 10px; }
        .template-card { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 10px; border-left: 4px solid #3498db; }
        .section-badge { display: inline-block; background: #3498db; color: white; padding: 3px 10px; margin: 2px; border-radius: 12px; font-size: 12px; }
        .match-score { font-size: 24px; font-weight: bold; text-align: center; padding: 10px; border-radius: 10px; }
        .high-match { background: #d4edda; color: #155724; }
        .medium-match { background: #fff3cd; color: #856404; }
        .low-match { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>üìö Template Management Dashboard</h1>
    
    <div class="dashboard">
        <div class="card">
            <h2>üè¢ Department Templates</h2>
            <div id="templatesList"></div>
        </div>
        
        <div class="card">
            <h2>üìä Template Statistics</h2>
            <div id="templateStats"></div>
        </div>
        
        <div class="card" style="grid-column: span 2;">
            <h2>üéØ Template Compliance</h2>
            <div id="complianceReports"></div>
        </div>
    </div>
    
    <script>
        const API_URL = 'http://localhost:8000';
        
        async function loadTemplates() {
            try {
                const response = await fetch(`${API_URL}/api/templates`);
                const data = await response.json();
                
                if (data.success) {
                    displayTemplates(data.templates);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        function displayTemplates(templates) {
            const container = document.getElementById('templatesList');
            let html = '';
            
            if (!templates || Object.keys(templates).length === 0) {
                html = '<p>No templates learned yet. Analyze some reports first!</p>';
            } else {
                for (const [dept, template] of Object.entries(templates)) {
                    html += `
                        <div class="template-card">
                            <h3>${dept}</h3>
                            <p><strong>Sections:</strong> ${template.sections_found?.join(', ') || 'None'}</p>
                            <p><strong>Usage:</strong> ${template.usage_count || 1} time(s)</p>
                            <p><strong>Last Updated:</strong> ${new Date(template.last_updated).toLocaleDateString()}</p>
                            <div>
                                <button onclick="viewTemplate('${dept}')" style="background: #3498db; color: white; border: none; padding: 5px 10px; border-radius: 5px; margin-right: 5px; cursor: pointer;">
                                    View Guide
                                </button>
                                <button onclick="analyzeSample('${dept}')" style="background: #27ae60; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">
                                    Test Report
                                </button>
                            </div>
                        </div>
                    `;
                }
            }
            
            container.innerHTML = html;
        }
        
        function viewTemplate(department) {
            window.open(`index.html?template=${department}`, '_blank');
        }
        
        function analyzeSample(department) {
            const sampleText = `Sample report for ${department}\n\nAccomplishments:\n- Item 1\n- Item 2\n\nChallenges:\n- Issue 1\n\nPlans:\n- Task 1`;
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; width: 80%; max-width: 600px; border-radius: 15px; padding: 30px;">
                    <h2>Test ${department} Template</h2>
                    <textarea id="testReport" rows="10" style="width: 100%; padding: 10px; margin: 10px 0;">${sampleText}</textarea>
                    <div style="text-align: right;">
                        <button onclick="validateTestReport('${department}')" style="background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            Validate
                        </button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-left: 10px;">
                            Cancel
                        </button>
                    </div>
                    <div id="testResult" style="margin-top: 20px;"></div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        async function validateTestReport(department) {
            const text = document.getElementById('testReport').value;
            
            const formData = new FormData();
            formData.append('department', department);
            const textFile = new Blob([text], { type: 'text/plain' });
            formData.append('file', textFile, 'test_report.txt');
            
            try {
                const response = await fetch(`${API_URL}/api/validate-report`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                const testResult = document.getElementById('testResult');
                
                if (result.success) {
                    const score = result.validation.template_match_score;
                    const scoreClass = score >= 80 ? 'high-match' : score >= 50 ? 'medium-match' : 'low-match';
                    
                    testResult.innerHTML = `
                        <div class="match-score ${scoreClass}">${score}% Match</div>
                        <p><strong>Validation:</strong> ${result.validation.valid ? '‚úÖ Pass' : '‚ùå Fail'}</p>
                        ${result.validation.missing_sections?.length ? `<p><strong>Missing:</strong> ${result.validation.missing_sections.join(', ')}</p>` : ''}
                    `;
                } else {
                    testResult.innerHTML = `<div style="color: #e74c3c;">Error: ${result.error}</div>`;
                }
            } catch (error) {
                document.getElementById('testResult').innerHTML = `<div style="color: #e74c3c;">Error: ${error.message}</div>`;
            }
        }
        
        window.onload = loadTemplates;
    </script>
</body>
</html>