<!DOCTYPE html>
<html>
<head>
    <title>Free Report Analyzer</title>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px;
            background: #f5f7fa;
        }
        .container { 
            background: white; 
            padding: 25px; 
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 { color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; }
        h2 { color: #34495e; margin-top: 0; }
        h3 { color: #2c3e50; margin-top: 20px; }
        input, select, button, textarea { 
            padding: 12px; 
            margin: 8px 0; 
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        button { 
            background: #3498db; 
            color: white; 
            border: none; 
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }
        button:hover { background: #2980b9; }
        .stats { 
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-box { 
            background: #ecf0f1; 
            padding: 15px; 
            border-radius: 10px;
            text-align: center;
        }
        .stat-number { 
            font-size: 28px; 
            font-weight: bold; 
            color: #2c3e50; 
        }
        .report-card { 
            background: white; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 8px;
            border-left: 5px solid #3498db;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .success { background: #d4edda; padding: 15px; border-radius: 8px; color: #155724; }
        .error { background: #f8d7da; padding: 15px; border-radius: 8px; color: #721c24; }
        .loading { text-align: center; padding: 20px; color: #7f8c8d; }
        #reportsContainer { max-height: 500px; overflow-y: auto; }
        .button-group { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
        .button-group button { width: auto; padding: 10px 20px; }
        .filter-group { margin: 15px 0; display: flex; align-items: center; gap: 10px; }
        .filter-group select { width: auto; padding: 8px 15px; }
        .report-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .report-department { font-weight: bold; color: #2c3e50; font-size: 16px; }
        .report-wordcount { background: #e3f2fd; padding: 3px 10px; border-radius: 12px; font-size: 12px; }
        .report-summary { color: #666; margin: 10px 0; font-size: 14px; line-height: 1.4; }
        .report-footer { display: flex; justify-content: space-between; color: #888; font-size: 12px; margin-top: 10px; }
        .file-input-label { 
            display: block; 
            padding: 15px; 
            border: 2px dashed #ddd; 
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            margin: 10px 0;
        }
        .file-input-label:hover { border-color: #3498db; background: #f8f9fa; }
        .sample-button { background: #9b59b6; }
        .sample-button:hover { background: #8e44ad; }
        .export-button { background: #27ae60; }
        .export-button:hover { background: #219653; }
        
        /* AI Analysis Styles */
        .ai-analysis {
            background: #f0f8ff;
            border-left: 4px solid #4CAF50;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .ai-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .ai-header h3 {
            margin: 0;
            color: #2c3e50;
        }
        .ai-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .ai-metric {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .ai-metric-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }
        .ai-metric-value {
            font-size: 20px;
            font-weight: bold;
            margin: 5px 0;
        }
        .ai-metric-label {
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
        }
        .ai-topics {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 10px 0;
        }
        .ai-topic {
            background: #3498db;
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 13px;
        }
        .ai-section {
            margin: 15px 0;
        }
        .ai-section-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .ai-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .ai-list-item {
            padding: 8px 12px;
            margin: 5px 0;
            background: white;
            border-radius: 6px;
            border-left: 3px solid #3498db;
        }
        .sentiment-positive { color: #27ae60; }
        .sentiment-negative { color: #e74c3c; }
        .sentiment-neutral { color: #f39c12; }
        .urgency-high { color: #e74c3c; }
        .urgency-medium { color: #f39c12; }
        .urgency-low { color: #27ae60; }
    </style>
</head>
<body>
    <div class="container">
        <h1>📊 Free Daily Report Analyzer</h1>
        <p>Upload daily reports from departments and get AI-powered analysis.</p>
        
        <div class="stats" id="stats">
            <div class="stat-box">
                <div class="stat-number">0</div>
                <div>Total Reports</div>
            </div>
            <div class="stat-box">
                <div class="stat-number">0</div>
                <div>Departments</div>
            </div>
            <div class="stat-box">
                <div class="stat-number">0</div>
                <div>Today's Reports</div>
            </div>
            <div class="stat-box">
                <div class="stat-number">🤖</div>
                <div>AI Active</div>
            </div>
        </div>
    </div>
    
    <div class="container">
        <h2>📤 Upload New Report</h2>
        
        <select id="department">
            <option value="">Select Department</option>
            <option value="Engineering">Engineering</option>
            <option value="Marketing">Marketing</option>
            <option value="Sales">Sales</option>
            <option value="HR">Human Resources</option>
            <option value="Finance">Finance</option>
            <option value="Operations">Operations</option>
            <option value="IT">IT</option>
            <option value="Customer Support">Customer Support</option>
        </select>
        
        <input type="date" id="date">
        
        <textarea id="reportText" placeholder="Paste your daily report here...

Example:
Daily Report - Engineering
Date: 2024-01-15

✅ Good: Fixed login bugs, deployed new API
⚠️ Bad: Database slow during peak hours
📋 Plan: Optimize queries, schedule team meeting
🚨 Urgent: Need to fix before Friday" rows="8"></textarea>
        
        <p style="text-align: center; color: #7f8c8d; margin: 15px 0;">- OR -</p>
        
        <label class="file-input-label">
            📁 Click to select a file (TXT, PDF, DOCX, XLSX, CSV)
            <input type="file" id="fileInput" accept=".txt,.pdf,.docx,.doc,.xlsx,.xls,.csv" style="display: none;">
            <div id="fileName" style="color: #666; font-size: 12px; margin-top: 5px;">No file selected</div>
        </label>
        
        <div class="button-group">
            <button onclick="uploadReport();" style="background: #3498db;">📊 Upload & Analyze with AI</button>
            <button onclick="addSampleReport();" class="sample-button">📋 Add Sample Report</button>
            <button onclick="downloadTemplate();" style="background: #16a085;">📄 Download Template</button>
        </div>

        <div class="button-group" style="margin-top: 15px;">
    <button onclick="analyzeTemplate()" style="background: #9b59b6;">
        📝 Learn Template from This Report
    </button>
    <button onclick="validateAgainstTemplate()" style="background: #f39c12;">
        🔍 Validate Against Template
    </button>
    <button onclick="viewAllTemplates()" style="background: #34495e;">
        📚 View All Templates
    </button>
</div>
        
        <div id="uploadResult"></div>
        
        <!-- AI Analysis Display (hidden by default) -->
        <div id="aiAnalysisContainer" style="display: none;"></div>
    </div>
    
    <div class="container">
        <h2>📋 Recent Reports with AI Analysis</h2>
        
        <div class="filter-group">
            <label>Filter by Department:</label>
            <select id="filterDept" onchange="filterReports();">
                <option value="">All Departments</option>
                <option value="Engineering">Engineering</option>
                <option value="Marketing">Marketing</option>
                <option value="Sales">Sales</option>
                <option value="HR">HR</option>
                <option value="Finance">Finance</option>
                <option value="Operations">Operations</option>
            </select>
            
            <label style="margin-left: 20px;">Filter by Sentiment:</label>
            <select id="filterSentiment" onchange="filterReports();">
                <option value="">All Sentiments</option>
                <option value="positive">Positive 😊</option>
                <option value="negative">Negative 😟</option>
                <option value="neutral">Neutral 😐</option>
            </select>
        </div>
        
        <div class="button-group">
            <button onclick="loadReports();">🔄 Refresh Reports</button>
            <button onclick="exportReports();" class="export-button">📥 Export to CSV</button>
            <button onclick="clearFilters();">🗑️ Clear Filters</button>
            <button onclick="showAIDashboard();" style="background: #9b59b6;">🤖 AI Dashboard</button>
        </div>
        
        <div id="reportsContainer">
            <div class="loading">Loading reports...</div>
        </div>
    </div>

    <script>
        // Configuration
        const API_URL = 'http://localhost:8000';
        let allReports = [];
        
        // Initialize on page load
        window.onload = function() {
            // Set today's date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
            
            // Setup file input display
            document.getElementById('fileInput').addEventListener('change', function(e) {
                const fileName = e.target.files[0] ? e.target.files[0].name : 'No file selected';
                document.getElementById('fileName').textContent = fileName;
            });
            
            // Load initial data
            loadStats();
            loadReports();
            
            // Auto-refresh every 30 seconds
            setInterval(loadStats, 30000);
        };
        
        // Load statistics
        async function loadStats() {
            try {
                const response = await fetch(`${API_URL}/api/stats`);
                const data = await response.json();
                
                const statsContainer = document.getElementById('stats');
                statsContainer.innerHTML = `
                    <div class="stat-box">
                        <div class="stat-number">${data.total_reports}</div>
                        <div>Total Reports</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${data.total_departments}</div>
                        <div>Departments</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${data.today_reports}</div>
                        <div>Today's Reports</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${data.ai_enabled ? '🤖' : '⚙️'}</div>
                        <div>${data.ai_enabled ? 'AI Active' : 'AI Loading'}</div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading stats:', error);
                document.getElementById('stats').innerHTML = 
                    '<div class="error">⚠️ Backend not running. Start backend first!</div>';
            }
        }
        
        // Upload report
        async function uploadReport() {
            const department = document.getElementById('department').value;
            const date = document.getElementById('date').value;
            const reportText = document.getElementById('reportText').value;
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            // Validation
            if (!department) {
                showResult('Please select a department', 'error');
                return;
            }
            
            if (!reportText && !file) {
                showResult('Please enter report text or select a file', 'error');
                return;
            }
            
            // Create form data
            const formData = new FormData();
            formData.append('department', department);
            formData.append('date', date);
            
            if (file) {
                formData.append('file', file);
            } else {
                // Create text file from textarea
                const textFile = new Blob([reportText], { type: 'text/plain' });
                formData.append('file', textFile, 'report.txt');
            }
            
            // Show loading
            showResult('Uploading and analyzing with AI...', 'loading');
            
            try {
                const response = await fetch(`${API_URL}/api/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showResult(`
                        <strong>✅ ${result.message}</strong><br><br>
                        <strong>Department:</strong> ${result.department}<br>
                        <strong>File Type:</strong> ${result.file_type}<br>
                        <strong>Words:</strong> ${result.word_count}
                    `, 'success');
                    
                    // Show AI Analysis
                    if (result.ai_analysis) {
                        showAIAnalysis(result.ai_analysis);
                    }
                    
                    // Clear form
                    document.getElementById('reportText').value = '';
                    fileInput.value = '';
                    document.getElementById('fileName').textContent = 'No file selected';
                    
                    // Refresh data
                    loadStats();
                    loadReports();
                } else {
                    showResult(`Error: ${result.error}`, 'error');
                }
            } catch (error) {
                showResult(`Network error: ${error.message}<br>Make sure backend is running at ${API_URL}`, 'error');
            }
        }
        
        // Display AI Analysis
        function showAIAnalysis(aiAnalysis) {
            const container = document.getElementById('aiAnalysisContainer');
            
            let html = `
                <div class="ai-analysis">
                    <div class="ai-header">
                        <span style="font-size: 24px;">🤖</span>
                        <h3>AI Analysis Results</h3>
                    </div>
                    
                    <div class="ai-metrics">
                        <div class="ai-metric">
                            <div class="ai-metric-icon sentiment-${aiAnalysis.sentiment.label}">
                                ${aiAnalysis.sentiment.label === 'positive' ? '😊' : 
                                  aiAnalysis.sentiment.label === 'negative' ? '😟' : '😐'}
                            </div>
                            <div class="ai-metric-value">${aiAnalysis.sentiment.label.toUpperCase()}</div>
                            <div class="ai-metric-label">Sentiment</div>
                            <div style="font-size: 12px; margin-top: 5px;">
                                Score: ${aiAnalysis.sentiment.score}<br>
                                +${aiAnalysis.sentiment.positive_words} / -${aiAnalysis.sentiment.negative_words}
                            </div>
                        </div>
                        
                        <div class="ai-metric">
                            <div class="ai-metric-icon urgency-${aiAnalysis.urgency}">
                                ${aiAnalysis.urgency === 'high' ? '🚨' : 
                                  aiAnalysis.urgency === 'medium' ? '⚠️' : '✅'}
                            </div>
                            <div class="ai-metric-value">${aiAnalysis.urgency.toUpperCase()}</div>
                            <div class="ai-metric-label">Urgency Level</div>
                        </div>
                        
                        <div class="ai-metric">
                            <div class="ai-metric-icon">📊</div>
                            <div class="ai-metric-value">${aiAnalysis.word_count}</div>
                            <div class="ai-metric-label">Words</div>
                        </div>
                        
                        <div class="ai-metric">
                            <div class="ai-metric-icon">🎯</div>
                            <div class="ai-metric-value">${aiAnalysis.topics.length}</div>
                            <div class="ai-metric-label">Topics Found</div>
                        </div>
                    </div>
                    
                    <div class="ai-section">
                        <div class="ai-section-title">🎯 Key Topics</div>
                        <div class="ai-topics">
            `;
            
            aiAnalysis.topics.forEach(topic => {
                html += `<span class="ai-topic">${topic}</span>`;
            });
            
            html += `
                        </div>
                    </div>
            `;
            
            if (aiAnalysis.accomplishments && aiAnalysis.accomplishments.length > 0) {
                html += `
                    <div class="ai-section">
                        <div class="ai-section-title">✅ Accomplishments</div>
                        <ul class="ai-list">
                `;
                aiAnalysis.accomplishments.forEach(acc => {
                    html += `<li class="ai-list-item">${acc}</li>`;
                });
                html += `</ul></div>`;
            }
            
            if (aiAnalysis.problems && aiAnalysis.problems.length > 0) {
                html += `
                    <div class="ai-section">
                        <div class="ai-section-title">⚠️ Challenges</div>
                        <ul class="ai-list">
                `;
                aiAnalysis.problems.forEach(prob => {
                    html += `<li class="ai-list-item">${prob}</li>`;
                });
                html += `</ul></div>`;
            }
            
            html += `
                    <div class="ai-section">
                        <div class="ai-section-title">📝 AI Summary</div>
                        <div style="background: white; padding: 15px; border-radius: 8px; font-style: italic;">
                            "${aiAnalysis.summary}"
                        </div>
                    </div>
                    
                    <button onclick="hideAIAnalysis()" style="margin-top: 15px; width: auto; padding: 8px 16px;">
                        Hide AI Analysis
                    </button>
                </div>
            `;
            
            container.innerHTML = html;
            container.style.display = 'block';
            
            // Auto-scroll to AI analysis
            container.scrollIntoView({ behavior: 'smooth' });
        }
        
        function hideAIAnalysis() {
            document.getElementById('aiAnalysisContainer').style.display = 'none';
        }
        
        // Load all reports
        async function loadReports() {
            const container = document.getElementById('reportsContainer');
            container.innerHTML = '<div class="loading">Loading reports with AI analysis...</div>';
            
            try {
                const response = await fetch(`${API_URL}/api/reports`);
                const data = await response.json();
                allReports = data.reports;
                filterReports();
            } catch (error) {
                container.innerHTML = `<div class="error">Error loading reports: ${error.message}</div>`;
            }
        }
        
        // Filter reports
        function filterReports() {
            const deptFilter = document.getElementById('filterDept').value;
            const sentimentFilter = document.getElementById('filterSentiment').value;
            const container = document.getElementById('reportsContainer');
            
            let filtered = allReports;
            
            if (deptFilter) {
                filtered = filtered.filter(r => r.department === deptFilter);
            }
            
            if (sentimentFilter) {
                filtered = filtered.filter(r => 
                    r.ai_analysis && 
                    r.ai_analysis.sentiment && 
                    r.ai_analysis.sentiment.label === sentimentFilter
                );
            }
            
            if (filtered.length === 0) {
                container.innerHTML = '<div class="report-card">No reports found matching filters.</div>';
                return;
            }
            
            let html = '';
            filtered.forEach(report => {
                const uploadDate = new Date(report.upload_date);
                const formattedDate = uploadDate.toLocaleDateString();
                const formattedTime = uploadDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                const ai = report.ai_analysis || {};
                const sentiment = ai.sentiment || { label: 'neutral', score: 0 };
                const topics = ai.topics || [];
                const summary = ai.summary || report.summary || 'No summary';
                
                html += `
                    <div class="report-card">
                        <div class="report-header">
                            <div class="report-department">${report.department}</div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                ${report.file_type ? `<span style="background: #e3f2fd; padding: 3px 8px; border-radius: 12px; font-size: 11px;">
                                    ${report.file_type}
                                </span>` : ''}
                                <span class="report-wordcount">${report.word_count || 0} words</span>
                            </div>
                        </div>
                        
                        <div class="report-summary">
                            ${summary.length > 200 ? summary.substring(0, 200) + '...' : summary}
                        </div>
                        
                        ${ai.sentiment ? `
                        <div style="margin: 10px 0; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 12px; color: #666;">AI Analysis:</span>
                            <span style="background: ${sentiment.label === 'positive' ? '#d4edda' : sentiment.label === 'negative' ? '#f8d7da' : '#fff3cd'}; 
                                  color: ${sentiment.label === 'positive' ? '#155724' : sentiment.label === 'negative' ? '#721c24' : '#856404'};
                                  padding: 3px 10px; border-radius: 12px; font-size: 12px;">
                                ${sentiment.label === 'positive' ? '😊 Positive' : sentiment.label === 'negative' ? '😟 Negative' : '😐 Neutral'} 
                                (${sentiment.score})
                            </span>
                            ${ai.urgency ? `<span style="background: #e3f2fd; padding: 3px 10px; border-radius: 12px; font-size: 12px;">
                                Urgency: ${ai.urgency}
                            </span>` : ''}
                        </div>
                        ` : ''}
                        
                        ${topics.length > 0 ? `
                        <div style="margin: 5px 0;">
                            <span style="font-size: 12px; color: #666;">Topics: </span>
                            ${topics.slice(0, 3).map(topic => 
                                `<span style="background: #f0f8ff; padding: 2px 8px; margin: 0 3px; border-radius: 10px; font-size: 11px;">${topic}</span>`
                            ).join(' ')}
                        </div>
                        ` : ''}
                        
                        <div class="report-footer">
                            <div>
                                <span>📅 ${formattedDate}</span>
                                <span style="margin-left: 10px;">🕒 ${formattedTime}</span>
                            </div>
                            <div>
                                <span>📝 ${report.filename || 'manual.txt'}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function clearFilters() {
            document.getElementById('filterDept').value = '';
            document.getElementById('filterSentiment').value = '';
            filterReports();
            showResult('Filters cleared', 'success');
        }
        
        // Add sample report
        function addSampleReport() {
            const departments = ['Engineering', 'Marketing', 'Sales', 'HR', 'Finance', 'Operations', 'IT'];
            const randomDept = departments[Math.floor(Math.random() * departments.length)];
            const today = new Date().toISOString().split('T')[0];
            
            const sampleReports = [
                `DAILY REPORT - ${randomDept}
Date: ${today}

✅ ACCOMPLISHMENTS:
- Successfully deployed new authentication system
- Fixed critical bug in payment processing
- Performance improved by 40%

⚠️ CHALLENGES:
- Database slow during peak hours
- Third-party API integration delayed
- Team member on sick leave

🚨 URGENT:
- Need to optimize database before Friday
- Security patch required

📋 PLANS:
- Schedule database optimization
- Meet with API provider
- Team training session

📊 METRICS:
- User satisfaction: +25%
- Page load: 1.8s (from 3.2s)
- Bugs resolved: 15`,

                `DEPARTMENT: ${randomDept}
STATUS: ${today}

GOOD NEWS:
✅ Campaign launched successfully
✅ Social media engagement up 30%
✅ Client feedback very positive

PROBLEMS:
⚠️ Budget constraints limiting ad spend
⚠️ Design team delayed deliverables
⚠️ Analytics tool issues

ACTION ITEMS:
1. Request additional budget
2. Follow up with design team
3. Fix analytics configuration

URGENCY: Medium
NOTES: Team performing well under constraints.`
            ];
            
            const randomReport = sampleReports[Math.floor(Math.random() * sampleReports.length)];
            
            document.getElementById('department').value = randomDept;
            document.getElementById('reportText').value = randomReport;
            
            showResult('Sample report loaded. Click "Upload & Analyze with AI" to see AI analysis.', 'success');
        }
        
        // Download template
        function downloadTemplate() {
            const template = `Department,Date,Accomplishments,Challenges,Plans,Urgency,Status
${document.getElementById('department').value || 'Engineering'},${document.getElementById('date').value},"Fixed bugs, Deployed features","Server issues, Time constraints","Code review, Testing","Medium","In Progress"
Marketing,${document.getElementById('date').value},"Campaign launch, Social media","Budget limits, Design delays","Analytics review, Client meetings","High","Planning"
Sales,${document.getElementById('date').value},"Closed deals, Client meetings","Competition, Market slow","Follow-ups, Proposals","Low","Completed"`;
            
            const blob = new Blob([template], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'daily_report_template.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showResult('CSV template downloaded. Fill it and upload for AI analysis!', 'success');
        }
        
        // Export reports
        async function exportReports() {
            try {
                const response = await fetch(`${API_URL}/api/reports`);
                const data = await response.json();
                
                let csv = 'ID,Department,Date,File Type,Word Count,Sentiment,Urgency,Summary\n';
                
                data.reports.forEach(report => {
                    const ai = report.ai_analysis || {};
                    const sentiment = ai.sentiment ? ai.sentiment.label : 'unknown';
                    const urgency = ai.urgency || 'unknown';
                    
                    csv += `"${report.id}","${report.department}","${report.report_date}","${report.file_type}",${report.word_count},"${sentiment}","${urgency}","${(report.summary || '').replace(/"/g, '""')}"\n`;
                });
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `reports_with_ai_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                showResult('✅ Reports exported with AI analysis!', 'success');
            } catch (error) {
                showResult(`Export failed: ${error.message}`, 'error');
            }
        }

        // Add these new functions
async function analyzeTemplate() {
    const department = document.getElementById('department').value;
    const fileInput = document.getElementById('fileInput');
    const file = fileInput.files[0];
    
    if (!department || !file) {
        showResult('Please select department and a sample report file', 'error');
        return;
    }
    
    showResult('Analyzing report template...', 'loading');
    
    const formData = new FormData();
    formData.append('department', department);
    formData.append('file', file);
    
    try {
        const response = await fetch(`${API_URL}/api/analyze-template`, {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            showResult(`
                <strong>✅ Template learned for ${department}!</strong><br><br>
                <strong>Sections detected:</strong> ${result.template.sections_found.join(', ')}<br>
                <strong>Bullet style:</strong> ${result.template.bullet_style || 'None'}<br>
                <strong>Date format:</strong> ${result.template.date_format}<br><br>
                <button onclick="showTemplateGuide('${department}')" style="background: #9b59b6; padding: 8px 16px; border-radius: 5px; border: none; color: white; cursor: pointer;">
                    View Template Guide
                </button>
            `, 'success');
        } else {
            showResult(`Error: ${result.error}`, 'error');
        }
    } catch (error) {
        showResult(`Template analysis failed: ${error.message}`, 'error');
    }
}

async function validateAgainstTemplate() {
    const department = document.getElementById('department').value;
    const reportText = document.getElementById('reportText').value;
    const fileInput = document.getElementById('fileInput');
    const file = fileInput.files[0];
    
    if (!department) {
        showResult('Please select a department first', 'error');
        return;
    }
    
    if (!reportText && !file) {
        showResult('Please enter report text or select a file', 'error');
        return;
    }
    
    showResult('Validating against template...', 'loading');
    
    const formData = new FormData();
    formData.append('department', department);
    
    if (file) {
        formData.append('file', file);
    } else {
        const textFile = new Blob([reportText], { type: 'text/plain' });
        formData.append('file', textFile, 'report.txt');
    }
    
    try {
        const response = await fetch(`${API_URL}/api/validate-report`, {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            const validation = result.validation;
            let html = `<strong>📋 Template Validation Results</strong><br><br>`;
            
            if (validation.valid) {
                html += `<span style="color: #27ae60;">✅ Report matches template</span><br>`;
            } else {
                html += `<span style="color: #e74c3c;">⚠️ Template issues found</span><br>`;
            }
            
            html += `<strong>Match Score:</strong> ${validation.template_match_score}/100<br>`;
            
            if (validation.missing_sections && validation.missing_sections.length > 0) {
                html += `<strong>Missing sections:</strong> ${validation.missing_sections.join(', ')}<br>`;
            }
            
            if (validation.warnings && validation.warnings.length > 0) {
                html += `<strong>Warnings:</strong><br>`;
                validation.warnings.forEach(warning => {
                    html += `• ${warning}<br>`;
                });
            }
            
            // Show structured data
            if (result.structured_data && result.structured_data.sections) {
                html += `<br><strong>📊 Extracted Structure:</strong><br>`;
                for (const [section, items] of Object.entries(result.structured_data.sections)) {
                    html += `<div style="margin-left: 20px;"><strong>${section}:</strong> ${items.length} items</div>`;
                }
            }
            
            showResult(html, validation.valid ? 'success' : 'error');
        } else {
            showResult(`Validation failed: ${result.error}`, 'error');
        }
    } catch (error) {
        showResult(`Validation error: ${error.message}`, 'error');
    }
}

async function showTemplateGuide(department) {
    try {
        const response = await fetch(`${API_URL}/api/templates/${department}`);
        const result = await response.json();
        
        if (result.success) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; width: 80%; max-width: 800px; max-height: 80%; border-radius: 15px; padding: 30px; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0;">📋 ${department} Template Guide</h2>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                style="background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">
                            Close
                        </button>
                    </div>
                    <div style="white-space: pre-wrap; font-family: monospace; background: #f8f9fa; padding: 20px; border-radius: 8px;">
                        ${result.guide}
                    </div>
                    <div style="margin-top: 20px;">
                        <button onclick="setTemplateSections('${department}')" 
                                style="background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                            Set Required Sections
                        </button>
                        <button onclick="downloadTemplateGuide('${department}')" 
                                style="background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            Download Guide
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        } else {
            showResult(`No template found for ${department}. Analyze a sample report first.`, 'error');
        }
    } catch (error) {
        showResult(`Error loading template: ${error.message}`, 'error');
    }
}

function setTemplateSections(department) {
    const sections = prompt(`Enter required sections for ${department} (comma-separated):\nExample: accomplishments, challenges, plans, metrics`);
    
    if (sections) {
        const sectionList = sections.split(',').map(s => s.trim().toLowerCase());
        
        fetch(`${API_URL}/api/set-template-sections`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `department=${encodeURIComponent(department)}&required_sections=${encodeURIComponent(JSON.stringify(sectionList))}`
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showResult(`✅ Updated required sections for ${department}`, 'success');
            } else {
                showResult(`Error: ${result.error}`, 'error');
            }
        })
        .catch(error => {
            showResult(`Error: ${error.message}`, 'error');
        });
    }
}

function downloadTemplateGuide(department) {
    const guide = document.querySelector('div[style*="white-space: pre-wrap"]').textContent;
    const blob = new Blob([guide], { type: 'text/markdown' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${department}_template_guide.md`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}
        
        // Show AI Dashboard
        function showAIDashboard() {
                window.open('ai_dashboard.html', '_blank');
}
        
        // Show result messages
        function showResult(message, type) {
            const resultDiv = document.getElementById('uploadResult');
            resultDiv.innerHTML = `<div class="${type}">${message}</div>`;
            
            // Auto-clear success messages after 8 seconds
            if (type === 'success') {
                setTimeout(() => {
                    if (resultDiv.innerHTML.includes('success')) {
                        resultDiv.innerHTML = '';
                    }
                }, 8000);
            }
        }
    </script>
</body>
</html>