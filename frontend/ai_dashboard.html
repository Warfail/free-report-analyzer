<!DOCTYPE html>
<html>
<head>
    <title>AI Analysis Dashboard</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 20px;
            background: #f5f7fa;
        }
        .dashboard { 
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .card { 
            background: white; 
            padding: 25px; 
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #2c3e50; border-bottom: 3px solid #9b59b6; padding-bottom: 10px; }
        h2 { color: #34495e; margin-top: 0; }
        .metric-grid { 
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .metric-box { 
            background: #ecf0f1; 
            padding: 20px; 
            border-radius: 10px;
            text-align: center;
        }
        .metric-value { 
            font-size: 32px; 
            font-weight: bold; 
            color: #2c3e50; 
        }
        .sentiment-box { 
            text-align: center; 
            padding: 20px; 
            border-radius: 10px; 
            margin: 10px 0; 
        }
        .positive { background: linear-gradient(135deg, #d4edda, #c3e6cb); color: #155724; }
        .negative { background: linear-gradient(135deg, #f8d7da, #f5c6cb); color: #721c24; }
        .neutral { background: linear-gradient(135deg, #fff3cd, #ffeaa7); color: #856404; }
        .topic-cloud { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 10px; 
            margin: 15px 0; 
        }
        .topic-tag { 
            background: #3498db; 
            color: white; 
            padding: 8px 15px; 
            border-radius: 20px;
            font-size: 14px;
        }
        .topic-tag.size-1 { font-size: 12px; opacity: 0.7; }
        .topic-tag.size-2 { font-size: 14px; opacity: 0.8; }
        .topic-tag.size-3 { font-size: 16px; opacity: 0.9; }
        .topic-tag.size-4 { font-size: 18px; opacity: 1; }
        .topic-tag.size-5 { font-size: 20px; opacity: 1; font-weight: bold; }
        .report-list { max-height: 400px; overflow-y: auto; }
        .report-item { 
            background: #f8f9fa; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 8px;
            border-left: 4px solid #9b59b6;
        }
        .chart-container { height: 300px; margin: 20px 0; }
        .loading { text-align: center; padding: 40px; color: #7f8c8d; font-size: 18px; }
        .error { background: #f8d7da; padding: 15px; border-radius: 8px; color: #721c24; }
        .button-group { display: flex; gap: 10px; margin: 20px 0; }
        button { 
            background: #9b59b6; 
            color: white; 
            border: none; 
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover { background: #8e44ad; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>ü§ñ AI Analysis Dashboard</h1>
    <p>Comprehensive view of AI insights across all reports</p>
    
    <div class="button-group">
        <button onclick="loadDashboard()">üîÑ Refresh Dashboard</button>
        <button onclick="window.location.href='index.html'">‚Üê Back to Main</button>
        <button onclick="exportAIData()">üì• Export AI Data</button>
    </div>
    
    <div class="dashboard">
        <!-- Sentiment Overview -->
        <div class="card">
            <h2>üìä Sentiment Analysis</h2>
            <div class="metric-grid">
                <div class="metric-box positive">
                    <div class="metric-value" id="positiveCount">0</div>
                    <div>Positive Reports</div>
                </div>
                <div class="metric-box negative">
                    <div class="metric-value" id="negativeCount">0</div>
                    <div>Negative Reports</div>
                </div>
                <div class="metric-box neutral">
                    <div class="metric-value" id="neutralCount">0</div>
                    <div>Neutral Reports</div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="sentimentChart"></canvas>
            </div>
        </div>
        
        <!-- Urgency Overview -->
        <div class="card">
            <h2>üö® Urgency Levels</h2>
            <div class="metric-grid">
                <div class="metric-box" style="background: #f8d7da;">
                    <div class="metric-value" id="highUrgency">0</div>
                    <div>High Urgency</div>
                </div>
                <div class="metric-box" style="background: #fff3cd;">
                    <div class="metric-value" id="mediumUrgency">0</div>
                    <div>Medium Urgency</div>
                </div>
                <div class="metric-box" style="background: #d4edda;">
                    <div class="metric-value" id="lowUrgency">0</div>
                    <div>Low Urgency</div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="urgencyChart"></canvas>
            </div>
        </div>
        
        <!-- Topics Cloud -->
        <div class="card">
            <h2>üéØ Topic Cloud</h2>
            <p>Most frequently mentioned topics across all reports</p>
            <div class="topic-cloud" id="topicCloud">
                <div class="loading">Loading topics...</div>
            </div>
            <div style="margin-top: 20px;">
                <h3>Top Departments</h3>
                <div id="departmentList"></div>
            </div>
        </div>
        
        <!-- Recent AI Analyses -->
        <div class="card">
            <h2>üìã Recent AI Analyses</h2>
            <div class="report-list" id="recentAnalyses">
                <div class="loading">Loading analyses...</div>
            </div>
        </div>
        
        <!-- AI Insights -->
        <div class="card" style="grid-column: span 2;">
            <h2>üí° AI Insights & Trends</h2>
            <div id="aiInsights">
                <div class="loading">Analyzing trends...</div>
            </div>
            <div style="margin-top: 20px;">
                <h3>üìà Performance Metrics</h3>
                <div class="metric-grid">
                    <div class="metric-box">
                        <div class="metric-value" id="avgWords">0</div>
                        <div>Avg Words/Report</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-value" id="avgSentiment">0</div>
                        <div>Avg Sentiment Score</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-value" id="reportsToday">0</div>
                        <div>Reports Today</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        let sentimentChart = null;
        let urgencyChart = null;
        
        // Initialize on load
        window.onload = function() {
            loadDashboard();
            // Auto-refresh every 60 seconds
            setInterval(loadDashboard, 60000);
        };
        
        async function loadDashboard() {
            try {
                // Load all reports
                const response = await fetch(`${API_URL}/api/reports`);
                const data = await response.json();
                
                if (!data.reports || data.reports.length === 0) {
                    showNoData();
                    return;
                }
                
                // Filter reports with AI analysis
                const aiReports = data.reports.filter(r => r.ai_analysis);
                
                if (aiReports.length === 0) {
                    document.getElementById('recentAnalyses').innerHTML = 
                        '<div class="error">No AI analyses yet. Upload some reports first!</div>';
                    return;
                }
                
                updateSentimentAnalysis(aiReports);
                updateUrgencyAnalysis(aiReports);
                updateTopicCloud(aiReports);
                updateRecentAnalyses(aiReports);
                updateAITrends(aiReports);
                updateMetrics(aiReports);
                
            } catch (error) {
                console.error('Dashboard error:', error);
                document.getElementById('recentAnalyses').innerHTML = 
                    `<div class="error">Error loading dashboard: ${error.message}</div>`;
            }
        }
        
        function updateSentimentAnalysis(reports) {
            const sentiments = { positive: 0, negative: 0, neutral: 0 };
            
            reports.forEach(r => {
                const sentiment = r.ai_analysis?.sentiment?.label || 'neutral';
                sentiments[sentiment]++;
            });
            
            // Update counts
            document.getElementById('positiveCount').textContent = sentiments.positive;
            document.getElementById('negativeCount').textContent = sentiments.negative;
            document.getElementById('neutralCount').textContent = sentiments.neutral;
            
            // Create/update chart
            const ctx = document.getElementById('sentimentChart').getContext('2d');
            
            if (sentimentChart) {
                sentimentChart.destroy();
            }
            
            sentimentChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Positive', 'Negative', 'Neutral'],
                    datasets: [{
                        data: [sentiments.positive, sentiments.negative, sentiments.neutral],
                        backgroundColor: ['#27ae60', '#e74c3c', '#f39c12'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = sentiments.positive + sentiments.negative + sentiments.neutral;
                                    const percentage = ((context.raw / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.raw} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function updateUrgencyAnalysis(reports) {
            const urgency = { high: 0, medium: 0, low: 0 };
            
            reports.forEach(r => {
                const level = r.ai_analysis?.urgency || 'low';
                urgency[level]++;
            });
            
            // Update counts
            document.getElementById('highUrgency').textContent = urgency.high;
            document.getElementById('mediumUrgency').textContent = urgency.medium;
            document.getElementById('lowUrgency').textContent = urgency.low;
            
            // Create/update chart
            const ctx = document.getElementById('urgencyChart').getContext('2d');
            
            if (urgencyChart) {
                urgencyChart.destroy();
            }
            
            urgencyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['High', 'Medium', 'Low'],
                    datasets: [{
                        label: 'Number of Reports',
                        data: [urgency.high, urgency.medium, urgency.low],
                        backgroundColor: ['#e74c3c', '#f39c12', '#27ae60'],
                        borderWidth: 1,
                        borderColor: '#2c3e50'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
        
        function updateTopicCloud(reports) {
            // Collect all topics
            const allTopics = [];
            const departments = {};
            
            reports.forEach(r => {
                // Get topics
                if (r.ai_analysis?.topics) {
                    allTopics.push(...r.ai_analysis.topics);
                }
                
                // Count departments
                if (r.department) {
                    departments[r.department] = (departments[r.department] || 0) + 1;
                }
            });
            
            // Count topic frequencies
            const topicCounts = {};
            allTopics.forEach(topic => {
                topicCounts[topic] = (topicCounts[topic] || 0) + 1;
            });
            
            // Sort by frequency and get top 20
            const sortedTopics = Object.entries(topicCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 20);
            
            // Create topic cloud
            const topicCloud = document.getElementById('topicCloud');
            topicCloud.innerHTML = '';
            
            sortedTopics.forEach(([topic, count]) => {
                // Determine size based on frequency
                let sizeClass = 'size-1';
                if (count > 5) sizeClass = 'size-5';
                else if (count > 3) sizeClass = 'size-4';
                else if (count > 2) sizeClass = 'size-3';
                else if (count > 1) sizeClass = 'size-2';
                
                const tag = document.createElement('div');
                tag.className = `topic-tag ${sizeClass}`;
                tag.textContent = topic;
                tag.title = `Mentioned ${count} time${count > 1 ? 's' : ''}`;
                topicCloud.appendChild(tag);
            });
            
            // Update department list
            const deptList = document.getElementById('departmentList');
            const sortedDepts = Object.entries(departments)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            deptList.innerHTML = '';
            sortedDepts.forEach(([dept, count]) => {
                const div = document.createElement('div');
                div.style.margin = '5px 0';
                div.innerHTML = `
                    <span style="font-weight: bold;">${dept}:</span>
                    <span style="color: #666; margin-left: 10px;">${count} report${count > 1 ? 's' : ''}</span>
                    <div style="width: 100%; height: 8px; background: #ecf0f1; border-radius: 4px; margin-top: 2px;">
                        <div style="width: ${(count / reports.length * 100)}%; height: 100%; background: #3498db; border-radius: 4px;"></div>
                    </div>
                `;
                deptList.appendChild(div);
            });
        }
        
        function updateRecentAnalyses(reports) {
            const container = document.getElementById('recentAnalyses');
            let html = '';
            
            // Get 5 most recent reports
            const recent = reports.slice(0, 5);
            
            recent.forEach(report => {
                const ai = report.ai_analysis;
                const date = new Date(report.upload_date);
                const formattedDate = date.toLocaleDateString();
                const formattedTime = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                html += `
                    <div class="report-item">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <strong style="color: #2c3e50;">${report.department}</strong>
                            <span style="background: ${ai.sentiment.label === 'positive' ? '#d4edda' : ai.sentiment.label === 'negative' ? '#f8d7da' : '#fff3cd'}; 
                                  color: ${ai.sentiment.label === 'positive' ? '#155724' : ai.sentiment.label === 'negative' ? '#721c24' : '#856404'};
                                  padding: 3px 10px; border-radius: 12px; font-size: 12px;">
                                ${ai.sentiment.label.toUpperCase()}
                            </span>
                        </div>
                        
                        <div style="margin: 8px 0; font-size: 14px; color: #666;">
                            ${ai.summary?.substring(0, 120) || 'No summary available'}...
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; font-size: 12px; color: #888;">
                            <div>
                                <span>üìÖ ${formattedDate}</span>
                                <span style="margin-left: 10px;">üïí ${formattedTime}</span>
                            </div>
                            <div>
                                <span>üéØ ${ai.topics?.slice(0, 2).join(', ') || 'No topics'}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function updateAITrends(reports) {
            const container = document.getElementById('aiInsights');
            
            // Calculate insights
            const totalReports = reports.length;
            const positiveReports = reports.filter(r => r.ai_analysis?.sentiment?.label === 'positive').length;
            const negativeReports = reports.filter(r => r.ai_analysis?.sentiment?.label === 'negative').length;
            const highUrgencyReports = reports.filter(r => r.ai_analysis?.urgency === 'high').length;
            
            // Find most common department
            const deptCounts = {};
            reports.forEach(r => {
                deptCounts[r.department] = (deptCounts[r.department] || 0) + 1;
            });
            const topDept = Object.entries(deptCounts).sort((a, b) => b[1] - a[1])[0];
            
            // Find most common topic
            const allTopics = [];
            reports.forEach(r => {
                if (r.ai_analysis?.topics) {
                    allTopics.push(...r.ai_analysis.topics);
                }
            });
            const topicCounts = {};
            allTopics.forEach(topic => {
                topicCounts[topic] = (topicCounts[topic] || 0) + 1;
            });
            const topTopic = Object.entries(topicCounts).sort((a, b) => b[1] - a[1])[0];
            
            // Generate insights
            const insights = [];
            
            if (positiveReports > negativeReports) {
                insights.push(`üéâ Overall sentiment is <strong>positive</strong> (${positiveReports} positive vs ${negativeReports} negative reports)`);
            } else if (negativeReports > positiveReports) {
                insights.push(`‚ö†Ô∏è Overall sentiment is <strong>negative</strong> (${negativeReports} negative vs ${positiveReports} positive reports)`);
            }
            
            if (highUrgencyReports > 0) {
                insights.push(`üö® There are <strong>${highUrgencyReports} high-urgency reports</strong> requiring attention`);
            }
            
            if (topDept) {
                insights.push(`üè¢ <strong>${topDept[0]}</strong> is the most active department with ${topDept[1]} reports`);
            }
            
            if (topTopic) {
                insights.push(`üéØ "<strong>${topTopic[0]}</strong>" is the most discussed topic (${topTopic[1]} mentions)`);
            }
            
            // Calculate trend (comparing last 5 reports with previous 5)
            if (reports.length >= 10) {
                const recent = reports.slice(0, 5);
                const previous = reports.slice(5, 10);
                
                const recentPositive = recent.filter(r => r.ai_analysis?.sentiment?.label === 'positive').length;
                const previousPositive = previous.filter(r => r.ai_analysis?.sentiment?.label === 'positive').length;
                
                if (recentPositive > previousPositive) {
                    insights.push(`üìà <strong>Positive trend:</strong> Recent reports show improved sentiment`);
                } else if (recentPositive < previousPositive) {
                    insights.push(`üìâ <strong>Attention needed:</strong> Recent reports show declining sentiment`);
                }
            }
            
            // Display insights
            let html = '<div style="display: grid; gap: 15px;">';
            insights.forEach(insight => {
                html += `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #9b59b6;">
                        ${insight}
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        function updateMetrics(reports) {
            // Average words
            const totalWords = reports.reduce((sum, r) => sum + (r.word_count || 0), 0);
            const avgWords = reports.length > 0 ? Math.round(totalWords / reports.length) : 0;
            document.getElementById('avgWords').textContent = avgWords;
            
            // Average sentiment score
            const totalScore = reports.reduce((sum, r) => sum + (r.ai_analysis?.sentiment?.score || 0), 0);
            const avgScore = reports.length > 0 ? (totalScore / reports.length).toFixed(2) : 0;
            document.getElementById('avgSentiment').textContent = avgScore;
            
            // Reports today
            const today = new Date().toISOString().split('T')[0];
            const todayReports = reports.filter(r => r.report_date === today).length;
            document.getElementById('reportsToday').textContent = todayReports;
        }
        
        function showNoData() {
            document.getElementById('recentAnalyses').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 48px;">ü§ñ</div>
                    <h3>No AI Data Yet</h3>
                    <p>Upload some reports to see AI analysis insights</p>
                    <button onclick="window.location.href='index.html'" 
                            style="margin-top: 20px; padding: 10px 20px; background: #9b59b6; color: white; border: none; border-radius: 8px; cursor: pointer;">
                        Go Upload Reports
                    </button>
                </div>
            `;
        }
        
        async function exportAIData() {
            try {
                const response = await fetch(`${API_URL}/api/reports`);
                const data = await response.json();
                
                if (!data.reports || data.reports.length === 0) {
                    alert('No data to export');
                    return;
                }
                
                // Create CSV with AI data
                let csv = 'ID,Department,Date,Word Count,File Type,Sentiment,Score,Urgency,Topics,Summary\n';
                
                data.reports.forEach(report => {
                    const ai = report.ai_analysis || {};
                    const sentiment = ai.sentiment?.label || 'unknown';
                    const score = ai.sentiment?.score || 0;
                    const urgency = ai.urgency || 'unknown';
                    const topics = ai.topics ? ai.topics.join('; ') : '';
                    const summary = (ai.summary || '').replace(/"/g, '""').replace(/\n/g, ' ');
                    
                    csv += `"${report.id}","${report.department}","${report.report_date}",${report.word_count},"${report.file_type}","${sentiment}",${score},"${urgency}","${topics}","${summary}"\n`;
                });
                
                // Download
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ai_analysis_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                alert('‚úÖ AI data exported successfully!');
                
            } catch (error) {
                alert(`Export failed: ${error.message}`);
            }
        }
    </script>
</body>
</html>